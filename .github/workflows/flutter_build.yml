name: Flutter Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Install Flutter
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      # 3️⃣ Get dependencies
      - name: Get dependencies
        run: flutter pub get

      # 4️⃣ Try building with existing android folder
      - name: Try building with existing android folder
        id: build-apk-primary
        continue-on-error: true
        run: flutter build apk --release

      # 5️⃣ Handle failed build regenerate android folder
      - name: Regenerate android folder if build failed
        if: steps.build-apk-primary.outcome == 'failure'
        run: |
          echo "⚠️ Initial build failed. Regenerating android/ folder."

          # Remove old android folder
          rm -rf android

          # Minimal android folder structure
          mkdir -p android/app/src/main
          mkdir -p android/gradle/wrapper

          # settings.gradle
          cat > android/settings.gradle <<'EOL'
            include ':app'
            rootProject.name = 'onechat'
            EOL

          # Project-level build.gradle
          cat > android/build.gradle <<'EOL'
            buildscript {
              ext.kotlin_version = '1.9.0'
            repositories {
               google()
              mavenCentral()
          }
          dependencies {
            classpath 'com.android.tools.build:gradle:8.1.1'
            classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
          }
          }
          allprojects {
            repositories {
                 google()
                 mavenCentral()
            }
          }
          EOL

          # App-level build.gradle
          cat > android/app/build.gradle <<'EOL'
apply plugin: 'com.android.application'

     android {
        namespace 'com.adith.onechat'
    compileSdk 34

    defaultConfig {
        applicationId "com.adith.onechat"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0.0"
    }
}

dependencies {
}
EOL

          # AndroidManifest.xml with Internet permission
          cat > android/app/src/main/AndroidManifest.xml <<'EOL'
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.adith.onechat">
    <uses-permission android:name="android.permission.INTERNET"/>
    <application
        android:label="OneChat"
        android:icon="@mipmap/ic_launcher">
    </application>
</manifest>
EOL

          # gradle-wrapper.properties
          mkdir -p android/gradle/wrapper
          cat > android/gradle/wrapper/gradle-wrapper.properties <<'EOL'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.2.1-bin.zip
EOL

          # Fetch dependencies for new android folder
          flutter pub get

          # Generate launcher icons from image/logo.png
          flutter pub run flutter_launcher_icons

      # 6️⃣ Retry build after regeneration
      - name: Retry build after regeneration
        if: steps.build-apk-primary.outcome == 'failure'
        run: flutter build apk --release

      # 7️⃣ Upload APK artifact
      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
